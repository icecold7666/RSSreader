# RSS Android应用开发计划

## 项目概述
- **项目名称**: RSS Android阅读器应用
- **目标平台**: Android 8.0+ (API 24+)
- **开发语言**: Kotlin + Compose
- **架构模式**: MVVM (Clean Architecture)
- **进度跟踪**: 本文档通过任务状态标记完成进度

## 当前状态
- **整体进度**: 95%
- **已实现**: 主体端到端闭环已完成（订阅源管理/抓取解析/入库/列表详情/搜索收藏已读/后台刷新）
- **主要待办**: 架构一致性收尾（Hilt 依赖注入链路恢复）与持续性能压测

## 一、依赖库配置与项目架构搭建 (Progress: 100%)

### 1.1 核心依赖配置 ✅
```kotlin
// 基础依赖
androidx.core.ktx:1.10.1
androidx.lifecycle:2.7.0
androidx.lifecycle.viewmodel.compose:2.7.0
androidx.activity.compose:1.8.0

// Compose UI
androidx.compose.material3:1.2.1
androidx.compose.material-icons-extended:1.2.1

// 网络请求
com.squareup.retrofit2:retrofit:2.9.0
com.squareup.retrofit2:converter-gson:2.9.0
com.squareup.okhttp3:okhttp:4.12.0
com.squareup.okhttp3:logging-interceptor:4.12.0

// 数据库
androidx.room:room-runtime:2.6.1
androidx.room:room-ktx:2.6.1
androidx.room:room-compiler:2.6.1

// 协程
org.jetbrains.kotlinx:kotlinx-coroutines-core:1.8.1
org.jetbrains.kotlinx:kotlinx-coroutines-android:1.8.1

// WorkManager
androidx.work:work-runtime-ktx:2.9.0

// 图片加载
io.coil-kt:coil-compose:2.5.0

// 导航
androidx.navigation:navigation-compose:2.7.7

// DataStore
androidx.datastore:datastore-preferences:1.1.0

// JSON
com.google.code.gson:gson:2.10.1
```

### 1.2 项目架构设计 ✅
```
com.example.rss/
├── data/
│   ├── local/
│   │   ├── database/       # Room数据库
│   │   ├── dao/            # 数据访问对象 ✅
│   │   └── entity/         # 实体类 ✅
│   ├── remote/
│   │   └── api/            # API接口（待实现）
│   └── repository/         # 仓库实现（待实现）
├── domain/
│   ├── model/              # 数据模型（待实现）
│   ├── repository/         # 仓库接口（待实现）
│   └── usecase/           # 用例（待实现）
├── presentation/
│   ├── ui/
│   │   ├── navigation/     # 导航图（待实现）
│   │   ├── theme/         # 主题 ✅
│   │   └── components/    # 通用组件（待实现）
│   ├── viewmodel/         # ViewModel（待实现）
│   └── util/              # 工具类（待实现）
└── util/                  # 工具类（待实现）
└── RssApplication.kt      # 应用入口 ✅
```

### 1.3 权限配置 ✅
```xml
<!-- AndroidManifest.xml -->
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.WAKE_LOCK" />
<uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
```

### 1.4 已完成功能
- ✅ 更新libs.versions.toml配置文件
- ✅ 添加所有必需依赖到app/build.gradle.kts
- ✅ 创建项目包结构
- ✅ 配置AndroidManifest.xml权限
- ✅ 创建RssApplication类
- ✅ 实现Room数据库和实体类
- ✅ 创建DAO接口
- ✅ 配置数据库工厂类
- ✅ 添加类型转换器

## 二、数据模型与数据库设计 (Progress: 100%)

### 2.1 实体类定义 ✅
```kotlin
// RSS源实体
@Entity(tableName = "rss_sources")
data class RssSourceEntity(
    @PrimaryKey(autoGenerate = true) val id: Long = 0,
    val title: String,
    val url: String,
    val description: String = "",
    val category: String = "默认分类",
    val isActive: Boolean = true,
    val lastUpdate: Long = 0,
    val imageUrl: String? = null,
    val customTitle: String? = null,
    val fetchInterval: Long = 3600000
)

// 文章实体
@Entity(tableName = "articles")
data class ArticleEntity(
    @PrimaryKey(autoGenerate = true) val id: Long = 0,
    val sourceId: Long,
    val title: String,
    val description: String,
    val content: String,
    val articleUrl: String,
    val imageUrl: String? = null,
    val publishedDate: Long,
    val author: String? = null,
    val isRead: Boolean = false,
    val isFavorite: Boolean = false,
    val hash: String,
    val createdAt: Long = System.currentTimeMillis(),
    val updatedAt: Long = System.currentTimeMillis()
)
```

### 2.2 DAO定义 ✅
```kotlin
@Dao
interface RssSourceDao {
    @Query("SELECT * FROM rss_sources ORDER BY title ASC")
    fun getAllSources(): Flow<List<RssSourceEntity>>

    @Query("SELECT * FROM rss_sources WHERE isActive = 1 ORDER BY title ASC")
    fun getActiveSources(): Flow<List<RssSourceEntity>>

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertSource(source: RssSourceEntity): Long

    @Update
    suspend fun updateSource(source: RssSourceEntity)

    @Delete
    suspend fun deleteSource(source: RssSourceEntity)
}

@Dao
interface ArticleDao {
    @Query("SELECT * FROM articles ORDER BY publishedDate DESC")
    fun getAllArticles(): PagingSource<Int, ArticleEntity>

    @Query("SELECT * FROM articles WHERE sourceId = :sourceId ORDER BY publishedDate DESC")
    fun getArticlesBySource(sourceId: Long): PagingSource<Int, ArticleEntity>

    @Query("SELECT * FROM articles WHERE isRead = 0 ORDER BY publishedDate DESC")
    fun getUnreadArticles(): PagingSource<Int, ArticleEntity>

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertAllArticles(articles: List<ArticleEntity>)

    @Update
    suspend fun updateArticle(article: ArticleEntity)

    @Query("UPDATE articles SET isRead = 1 WHERE id = :articleId")
    suspend fun markAsRead(articleId: Long)
}
```

### 2.3 数据库配置 ✅
```kotlin
@Database(entities = [RssSourceEntity::class, ArticleEntity::class], version = 1)
@TypeConverters(Converters::class)
abstract class AppDatabase : RoomDatabase() {
    abstract fun rssSourceDao(): RssSourceDao
    abstract fun articleDao(): ArticleDao
}
```

### 2.4 已完成功能
- ✅ 创建了领域模型（RssSource、Article）
- ✅ 定义了实体类（RssSourceEntity、ArticleEntity）
- ✅ 实现了所有DAO接口（RssSourceDao、ArticleDao）
- ✅ 创建了数据库类和类型转换器
- ✅ 实现了Repository接口（RssSourceRepository、ArticleRepository）
- ✅ 创建了Repository实现类（RssSourceRepositoryImpl、ArticleRepositoryImpl）
- ✅ 实现了UseCase（AddRssSourceUseCase、RefreshRssSourcesUseCase、MarkArticleAsReadUseCase）
- ✅ 创建了数据库测试类

### 2.5 待完成功能
- [x] 实现RssApiService接口
- [x] 创建RssParser解析器
- [ ] 创建依赖注入配置（当前为 ServiceLocator，待对齐 Hilt）

## 三、RSS源管理功能 (Progress: 100%)

### 3.1 API接口设计 ✅
```kotlin
interface RssApiService {
    @GET
    suspend fun fetchRssFeed(@Url url: String): ResponseBody

    @GET
    suspend fun fetchAtomFeed(@Url url: String): ResponseBody

    @GET
    suspend fun fetchJsonFeed(@Url url: String): ResponseBody
}

class RssParser {
    suspend fun parseRssFeed(content: String, sourceId: Long): Result<List<ArticleEntity>> {
        // 实现RSS 2.0解析 ✅
    }

    suspend fun parseAtomFeed(content: String, sourceId: Long): Result<List<ArticleEntity>> {
        // 实现Atom 1.0解析 ✅
    }
}
```

### 3.2 仓库实现 ✅
```kotlin
class RssSourceRepositoryImpl @Inject constructor(
    private val rssSourceDao: RssSourceDao,
    private val rssApiService: RssApiService,
    private val rssParser: RssParser
) : RssSourceRepository {
    // 实现了所有Repository接口方法 ✅
}
```

### 3.3 UI组件设计 ✅
```kotlin
// RSS源列表界面 ✅
@Composable
fun RssSourceListScreen(
    viewModel: RssSourceViewModel,
    onAddSource: () -> Unit,
    onEditSource: (RssSource) -> Unit
)

// 添加RSS源对话框 ✅
@Composable
fun AddRssSourceDialog(
    onDismiss: () -> Unit,
    onConfirm: (RssSource) -> Unit
)
```

### 3.4 已完成功能
- ✅ 实现RssApiService接口
- ✅ 创建RssParser解析器（支持RSS 2.0、Atom 1.0）
- ✅ 创建Retrofit客户端配置
- ✅ 实现RssSourceRepository和ArticleRepository
- ✅ 创建RssSourceViewModel
- ✅ 实现RSS源列表UI组件
- ✅ 实现添加RSS源对话框
- ✅ 创建了依赖注入配置(AppModule)

### 3.5 待完成功能
- [ ] 修复依赖注入问题（待对齐 Hilt）
- [x] 实现文章获取与解析功能
- [x] 创建文章展示界面

## 四、文章获取与解析 (Progress: 100%)

### 4.1 内容获取服务 ✅
```kotlin
class ContentFetchService(
    private val rssSourceDao: RssSourceDao,
    private val articleDao: ArticleDao,
    private val rssApiService: RssApiService,
    private val rssParser: RssParser
) {
    suspend fun fetchArticlesFromUrl(url: String, sourceId: Long): Result<List<Article>> ✅
    fun generateArticleHash(title: String, url: String): String ✅
    fun isDuplicate(content: String, sourceId: Long): Boolean ✅
    suspend fun fetchArticlesForSource(sourceId: Long): Result<Int> ✅
    suspend fun fetchAllSourcesArticles(): Result<Int> ✅
}
```

### 4.2 定时刷新服务 ✅
```kotlin
@HiltWorker
class RefreshWorker(
    context: Context,
    params: WorkerParameters,
    private val rssSourceDao: RssSourceDao,
    private val contentFetchService: ContentFetchService
) : CoroutineWorker(context, params) {
    override suspend fun doWork(): Result ✅
    companion object {
        fun createPeriodicRequest(): PeriodicWorkRequest ✅
        fun createOneTimeRequest(): OneTimeWorkRequest ✅
    }
}
```

### 4.3 数据同步 ✅
```kotlin
class DataSyncManager(
    @ApplicationContext private val context: Context
) {
    fun schedulePeriodicRefresh(config: RefreshConfig = currentConfig) ✅
    fun cancelAllRefreshes() ✅
    fun refreshNow(sourceId: Long? = null) ✅
    fun getRefreshStatus(): Flow<WorkInfo> ✅
    fun isRefreshing(): Boolean ✅
    fun setRefreshInterval(minutes: Long) ✅
    fun setAutoRefreshEnabled(enabled: Boolean) ✅
}
```

### 4.4 已完成功能
- ✅ 实现ContentFetchService（支持RSS 2.0、Atom 1.0解析）
- ✅ 创建RefreshWorker（支持定时刷新）
- ✅ 实现DataSyncManager（管理所有同步任务）
- ✅ 完善Repository中的解析逻辑
- ✅ 实现文章去重机制
- ✅ 创建了完整的测试用例

### 4.5 待完成功能
- [x] 创建文章展示与阅读功能
- [x] 实现文章搜索功能
- [x] 创建收藏功能

## 五、文章展示与阅读 (Progress: 100%)

### 5.1 文章列表界面
```kotlin
@Composable
fun ArticleListScreen(
    sourceId: Long,
    viewModel: ArticleViewModel,
    onArticleClick: (Article) -> Unit
)

@Composable
fun ArticleItem(
    article: Article,
    onMarkAsRead: (Long) -> Unit,
    onToggleFavorite: (Long) -> Unit
)
```

### 5.2 文章详情界面
```kotlin
@Composable
fun ArticleDetailScreen(
    articleId: Long,
    viewModel: ArticleViewModel,
    onBack: () -> Unit
)
```

### 5.3 搜索功能
```kotlin
@Composable
fun SearchScreen(
    viewModel: SearchViewModel,
    onArticleClick: (Article) -> Unit
)
```

### 5.4 任务检查点
- [x] 实现文章列表UI
- [x] 创建文章项组件
- [x] 实现文章详情页面
- [x] 添加HTML渲染支持
- [x] 实现搜索功能
- [x] 测试文章展示功能

## 六、扩展功能 (Progress: 100%)

### 6.1 收藏与离线阅读
- [x] 实现收藏功能
- [x] 添加离线下载支持
- [x] 实现离线阅读模式

### 6.2 个性化设置
- [x] 创建设置页面
- [x] 实现定时刷新设置
- [x] 添加主题切换功能

### 6.3 分享与导出
- [x] 实现文章分享功能
- [x] 添加导入/导出RSS源功能
- [x] 实现数据备份功能

## 七、测试与优化 (Progress: 100%)

### 7.1 单元测试
- [x] Repository测试
- [x] ViewModel测试
- [x] UseCase测试

### 7.2 UI测试
- [x] 列表界面测试
- [x] 表单输入测试
- [x] 导航测试

### 7.3 性能优化
- [x] 图片加载优化
- [x] 列表滚动性能优化
- [x] 内存优化

## 开发进度跟踪

### 当前进度统计
- **整体进度**: 95% (主体闭环完成，剩架构一致性收尾)
- **依赖配置**: 100%
- **数据库设计**: 100%
- **RSS源管理**: 100%
- **文章获取**: 100%
- **文章展示**: 100%
- **扩展功能**: 100%
- **测试优化**: 100%

### 下一阶段任务
1. 对齐依赖注入到 Hilt（替换 ServiceLocator）
2. 做性能基线实测并固化指标（首开/解析/内存）
3. 补齐回归测试与错误态覆盖

### 更新日志
- 2024-02-23:
  - 完成第1-4阶段功能开发
  - 创建进度标记和任务清单
  - 项目架构搭建完成
- 2026-02-27:
  - 修复 RssSourceViewModel 重复订阅与 Result 误用
  - 修复 SearchViewModel 搜索协程叠加问题并优化搜索列表键值
  - 新增 RssSourceViewModel 单测并通过 compile/lint/unit test/assemble
